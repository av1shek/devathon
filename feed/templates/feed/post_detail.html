{% extends "feed/base.html" %}
{% block content %}
	<article class="media content-section">
	  {% if post.anonymous %}
      	<img class="rounded-circle article-img" src="/media/default.jpg">
      {% else %}
		<img class="rounded-circle article-img" src="{{ post.author.profile.image.url }}">
      {% endif %}
	  <div class="media-body">
	    <div class="article-metadata">
	      {% if post.anonymous %}
          	<a class="mr-2" href="#">Anonymous</a>
          {% else %}
		    <a class="mr-2" href="{% url 'profile' post.author.id %}">{{ post.author }}</a>
          {% endif %}
	      <small class="text-muted">{{ post.date_posted|date:"F d, Y" }}</small>
	      {% if post.author == user %}
	      	<div>
	      		<a class="btn btn-secondary btn-sm mt-1 mb-1" href="{% url 'post-update' post.id %}">Update</a>
	      		<a class="btn btn-danger btn-sm mt-1 mb-1" href="{% url 'post-delete' post.id %}">Delete</a>
	      	</div>
	      {% endif %}
	    </div>
	    <h2 class="article-title">{{ post.title }}</h2>
	    {% if post.image %}
          <img style="width:100%; height:auto;" src="{{ post.image.url }}">
        {% endif %}
	    <p class="article-content">{{ post.content }}</p>

		{% if user.is_authenticated %}
		  <button type="button" name="post_id" id="upvote" class="btn btn-info"><span id="up_cnt">{{upvotes}}</span> Up</button>
		  <button type="button" name="post_id" id="downvote" class="btn btn-info"><span id="down_cnt">{{downvotes}}</span> Down</button>
		{% else %}
		  <a class="btn btn-outline-info" href="{% url 'login' %}?next={{request.path}}">Log in to upvote / downvote this article!</a><br>
		{% endif %}
		

	  </div>
	</article>

	
{% endblock content %}

{% block script %}
<script type="text/javascript">

async function updateUpvoteDownVote(url, only_check)
{
	var csrftoken = "{{csrf_token}}";

	let postId = {{object.id}};
	const obj = {post_id: postId, only_check: only_check};
	const data = JSON.stringify(obj);

	let params = {
				method: 'POST',
				body: data,
				headers: { 'Accept': 'application/json, text/plain',
					'Content-Type': 'application/json',
					"X-CSRFToken": csrftoken },
				}
	
	
	await fetch(url, params).then(response => response.json()).then(data => {qnty=data; return qnty;} );
	return qnty;
}

document.getElementById("upvote").addEventListener("click", function() {

	let up_url = "{% url 'post-upvote' object.id %}";
	let down_url = "{% url 'post-downvote' object.id %}";

	updateUpvoteDownVote(up_url, 0).then(qnty => {
		document.getElementById('up_cnt').innerHTML= qnty;
		
		updateUpvoteDownVote(down_url, 1).then(qnty => {
		document.getElementById('down_cnt').innerHTML= qnty;
		console.log(qnty);
		})
	})
});


document.getElementById("downvote").addEventListener("click", function() {

	let up_url = "{% url 'post-upvote' object.id %}";
	let down_url = "{% url 'post-downvote' object.id %}";

	updateUpvoteDownVote(down_url, 0).then(qnty => {
		document.getElementById('down_cnt').innerHTML= qnty;
		updateUpvoteDownVote(up_url, 1).then(qnty => {
		document.getElementById('up_cnt').innerHTML= qnty;
		console.log(qnty);
	})
	})	
});


	</script>
{% endblock script %}